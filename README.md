# Drom Car Search API

## О проекте
Этот проект представляет собой веб-сервис для поиска автомобилей на сайте drom.ru. Сервис предоставляет REST API для поиска автомобилей с различными параметрами, такими как марка, модель, год выпуска, цена и другие характеристики. API автоматически собирает данные со всех доступных страниц результатов поиска и сохраняет их в локальную базу данных для быстрого доступа.

### Основные возможности
- Поиск автомобилей по различным параметрам
- Автоматический сбор данных с drom.ru
- REST API для доступа к данным
- Локальное кэширование результатов в базе данных
- Поддержка Docker для простого развертывания

## Установка и запуск

### Предварительные требования
- Python 3.8 или выше
- Docker и Docker Compose (для запуска в контейнерах)
- PostgreSQL (если запускаете без Docker)

### Запуск с использованием Docker

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd drom
```

2. Создайте файл `.env` в корневой директории проекта со следующими переменными:
```
DB_NAME=your_db_name
DB_USER=your_db_user
DB_PASSWORD=your_db_password
DB_HOST=db
DB_PORT=5432
DEBUG=0
SECRET_KEY=your_secret_key
```

3. Запустите проект с помощью Docker Compose:
```bash
docker-compose up --build
```

Сервис будет доступен по адресу: http://localhost:80

### Локальный запуск (без Docker)

1. Создайте и активируйте виртуальное окружение:
```bash
python -m venv .venv
source .venv/bin/activate  # для Linux/Mac
# или
.venv\Scripts\activate  # для Windows
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Создайте файл `.env` с настройками базы данных и другими параметрами:
```
DB_NAME=your_db_name
DB_USER=your_db_user
DB_PASSWORD=your_db_password
DB_HOST=localhost
DB_PORT=5432
DEBUG=1
SECRET_KEY=your_secret_key
```

4. Примените миграции:
```bash
python manage.py migrate
```

5. Запустите сервер разработки:
```bash
python manage.py runserver
```

Сервис будет доступен по адресу: http://localhost:8000

## Тестирование API

Для тестирования API вы можете использовать включенный файл `test_api.py`:

```bash
python test_api.py
```

## Документация API

## Обзор
API предоставляет доступ к функциональности поиска автомобилей на drom.ru. Позволяет искать автомобили по различным параметрам и возвращает подробную информацию о найденных транспортных средствах. API автоматически получает данные со всех доступных страниц результатов.

## Базовый URL
```
http://your-domain.com/api/search/
```

## Конечные точки

### Поиск автомобилей
```
GET /api/search/
```

#### Параметры запроса
```json
{
    "marka": "string",           // Марка автомобиля (необязательно)
    "model": "string",           // Модель автомобиля (необязательно)
    "price_min": number,         // Минимальная цена (необязательно)
    "price_max": number,         // Максимальная цена (необязательно)
    "year_min": number,          // Минимальный год выпуска (необязательно)
    "year_max": number,          // Максимальный год выпуска (необязательно)
    "fuel_types": [              // Типы топлива (необязательно)
        "0",                     // Бензин
        "1",                     // Дизель
        "2",                     // Электричество
        "3",                     // Газ
        "4"                      // Газ/Дизель
    ],
    "drive_types": [             // Типы привода (необязательно)
        "1",                     // Передний
        "2",                     // Задний
        "3"                      // Полный
    ],
    "trans_types": [             // Типы трансмиссии (необязательно)
        "0",                     // Механическая
        "1",                     // Вариатор
        "2",                     // Автомат
        "3",                     // Робот
        "4"                      // Редуктор
    ],
    "volume_min": number,        // Минимальный объем двигателя (необязательно)
    "volume_max": number,        // Максимальный объем двигателя (необязательно)
    "power_min": number,         // Минимальная мощность (необязательно)
    "power_max": number          // Максимальная мощность (необязательно)
}
```

#### Формат ответа
```json
[
    {
        "model": "string",           // Название модели автомобиля
        "model_url": "string",       // URL страницы автомобиля
        "image_url": "string",       // URL изображения автомобиля
        "complectation": [           // Список комплектаций
            {
                "name": "string",    // Название комплектации
                "features": {         // Характеристики автомобиля
                    "volume": "string",      // Объем двигателя (например, "2.5 л")
                    "fuel_type": "string",   // Тип топлива (например, "бензин")
                    "power": "string",       // Мощность (например, "181 л.с.")
                    "transmission": "string", // Тип трансмиссии (например, "АКПП")
                    "drive": "string"        // Тип привода (например, "передний привод")
                },
                "price": "string",   // Цена автомобиля
                "year": "string"     // Год выпуска
            }
        ]
    }
]
```

#### Пример ответа
```json
[
    {
        "model": "Toyota Camry",
        "model_url": "https://www.drom.ru/catalog/toyota/camry/...",
        "image_url": "https://example.com/image.jpg",
        "complectation": [
            {
                "name": "Comfort",
                "features": {
                    "volume": "2.5 л",
                    "fuel_type": "бензин",
                    "power": "181 л.с.",
                    "transmission": "АКПП",
                    "drive": "передний привод"
                },
                "price": "1 500 000 ₽",
                "year": "2022"
            },
            {
                "name": "Prestige",
                "features": {
                    "volume": "3.5 л",
                    "fuel_type": "бензин",
                    "power": "249 л.с.",
                    "transmission": "АКПП",
                    "drive": "полный привод"
                },
                "price": "2 000 000 ₽",
                "year": "2023"
            }
        ]
    }
]
```

#### Ответы с ошибками

##### 400 Некорректный запрос
```json
{
    "error": "string",  // Описание ошибки валидации
    "details": {
        "message": "string"  // Подробное сообщение об ошибке
    }
}
```

##### 500 Внутренняя ошибка сервера
```json
{
    "error": "string",  // Описание серверной ошибки
    "details": {
        "message": "string"  // Подробное сообщение об ошибке
    }
}
```

### Таблица: Car (Автомобиль)
| Поле | Тип | Описание | Ограничения |
|-------|------|-------------|-------------|
| id | Integer | Первичный ключ | Автоинкремент |
| model | CharField(255) | Название модели | - |
| model_url | URLField | URL страницы модели | - |
| image_url | URLField | URL изображения | - |

### Таблица: Complectation (Комплектация)
| Поле | Тип | Описание | Ограничения |
|-------|------|-------------|-------------|
| id | Integer | Первичный ключ | Автоинкремент |
| car | ForeignKey | Ссылка на модель Car | on_delete=CASCADE |
| name | CharField(255) | Название комплектации | - |
| volume | CharField(50) | Объем двигателя | - |
| fuel_type | CharField(50) | Тип топлива | - |
| power | CharField(50) | Мощность двигателя | - |
| transmission | CharField(50) | Тип трансмиссии | - |
| drive | CharField(50) | Тип привода | - |
| price | CharField(50) | Цена | - |
| year | CharField(4) | Год выпуска | - |

## Связи между таблицами
- Один автомобиль может иметь много комплектаций (связь "один ко многим")
- Комплектация принадлежит одному автомобилю (связь "многие к одному")


### Поиск автомобилей в базе данных
```
GET /api/search_cars/
```

Этот эндпоинт осуществляет поиск автомобилей в локальной базе данных на основе различных параметров. Возвращает автомобили, у которых хотя бы одна комплектация соответствует указанным критериям.

#### Параметры запроса
Все параметры являются необязательными. Если параметры не указаны, будут возвращены все автомобили со всеми комплектациями.

```json
{
    "model": "string",           // Название модели (частичное совпадение, без учета регистра)
    "year_min": "string",        // Минимальный год выпуска (например, "2020")
    "year_max": "string",        // Максимальный год выпуска (например, "2023")
    "price_min": "string",       // Минимальная цена (например, "1000000")
    "price_max": "string",       // Максимальная цена (например, "5000000")
    "fuel_type": "string",       // Тип топлива (например, "бензин", "дизель")
    "drive_type": "string",      // Тип привода (например, "передний", "задний")
    "transmission": "string",    // Тип трансмиссии (например, "автомат", "механика")
    "volume_min": "string",      // Минимальный объем двигателя (например, "1.6")
    "volume_max": "string",      // Максимальный объем двигателя (например, "3.0")
    "power_min": "string",       // Минимальная мощность (например, "100")
    "power_max": "string"        // Максимальная мощность (например, "300")
}
```

#### Формат ответа
```json
{
    "status": "success",
    "count": number,             // Количество найденных автомобилей
    "results": [                 // Список автомобилей
        {
            "id": number,        // ID автомобиля
            "model": "string",   // Название модели
            "model_url": "string", // URL страницы модели
            "image_url": "string", // URL изображения
            "complectations": [  // Список подходящих комплектаций
                {
                    "id": number,           // ID комплектации
                    "name": "string",       // Название комплектации
                    "volume": "string",     // Объем двигателя
                    "fuel_type": "string",  // Тип топлива
                    "power": "string",      // Мощность
                    "transmission": "string", // Тип трансмиссии
                    "drive": "string",      // Тип привода
                    "price": "string",      // Цена
                    "year": "string"        // Год выпуска
                }
            ]
        }
    ]
}
```

#### Пример запроса
```
GET /api/search_cars/?model=Toyota&year_min=2020&price_max=5000000
```

#### Пример ответа
```json
{
    "status": "success",
    "count": 2,
    "results": [
        {
            "id": 1,
            "model": "Toyota Camry",
            "model_url": "https://example.com/toyota-camry",
            "image_url": "https://example.com/toyota-camry.jpg",
            "complectations": [
                {
                    "id": 1,
                    "name": "Comfort",
                    "volume": "2.5 л",
                    "fuel_type": "бензин",
                    "power": "181 л.с.",
                    "transmission": "автомат",
                    "drive": "передний",
                    "price": "2500000",
                    "year": "2021"
                }
            ]
        }
    ]
}
```
